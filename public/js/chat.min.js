function loadMessages(e,t=0){return new Promise((n,s)=>{const i=new XMLHttpRequest;i.addEventListener("load",function(){const e=JSON.parse(this.response);n(e)}),i.addEventListener("error",s),i.open("GET",`/message/load?rid=${e}&step=${t}`),i.setRequestHeader("Accept","application/json"),i.send()})}function newMessage(e,t=0){const n=document.getElementsByClassName("message");let s=document.getElementById("bell"),i=`<li class="message" data-scroll="${e.scroll}">\n\t<div class="message-wrapper${getCookie("uid").indexOf(e.sender.id)>=0?" you":""}"> \n\t<div class="message-content">\n\t<b class="message-sender">${e.sender.name}:</b><br/>\n\t${txt2Emoji(e.msg.text)}<br/>\n\t${showFiles(e.msg.file)}\n\t</div>\n\t<p class="message-time">${e.created.formatTime()}</p>\n\t</div>\n\t</li>`;if(0===t)getCookie("uid").indexOf(e.sender.id)>=0&&document.getElementsByClassName("preview").length>0&&document.getElementsByClassName("preview")[0].remove(),messages.innerHTML+=i,n[n.length-1].scrollIntoView({block:"end",inline:"end"}),getCookie("uid").indexOf(e.sender.id)<0&&s.play();else{messages.insertAdjacentHTML("afterbegin",i);for(let e=n.length-1;e>=0;e--)1==n[e].getAttribute("data-scroll")&&n[e].scrollIntoView({block:"end",inline:"end"}),setTimeout(()=>n[e].removeAttribute("data-scroll"),100)}}function caughtEmptyMsg(e){let t=document.getElementsByClassName("input")[0];if(!hasChild(t,"error")){let n=document.createElement("p");n.className="error show",n.innerText=e,t.appendChild(n),n.addEventListener("animationend",()=>{n.classList.remove("show"),n.remove()})}}function showFiles(e){let t="";if(null!==e)for(let n of e)0===n.path.indexOf("image")?t+=`<div class="preview_file preview_file-img">\n\t\t\t\t<img src="/file/${n.path}">\n\t\t\t\t</div>`:t+=`<a href="/file/${n.path}" class="preview_file" download>\n\t\t\t\t<i class="fa fa-download fa-white preview_file-icon"></i>\n\t\t\t\t<div class="preview_file-name">${n.name}</div>\n\t\t\t\t</a>`;return t}function txt2Emoji(e){return e.replace(/:(\w+[-\w+]*):/g,'<i class="fa fa-$1" data-ic="$1"></i>')}function getCookie(e){let t=e+"=",n=decodeURIComponent(document.cookie).split(";");for(let e=0;e<n.length;e++){let s=n[e];for(;" "==s.charAt(0);)s=s.substring(1);if(0==s.indexOf(t))return s.substring(t.length,s.length)}return""}function setCookie(e,t,n){let s=new Date;s.setTime(s.getTime()+24*n*36e5),n="expires="+s.toUTCString(),document.cookie=e+"="+t+";"+n+";path=/"}function hasChild(e,t){let n=e.children;for(let e=n.length-1;e>=0;e--)if(n[e].classList.contains(t))return!0;return!1}function MenuActivator(e){this.listItem=e.listItem,this.activeClass=e.activeClass,this.url=location.pathname,this.getCurrentPage=function(e,t){if("/"===t)return e[0];let n=t.split("/").pop();n=new RegExp(n.replace(/\.(html?|php)/,""),"i");for(let s=e.length-1;s>=0;s--)if("/"!==t&&n.test(e[s].href))return e[s]},this.activate=function(){let e=this.getCurrentPage(this.listItem,this.url);e&&e.classList.add(this.activeClass)}}window.addEventListener("load",function(){function e(e){new Promise((e,t)=>{const n=new XMLHttpRequest,s=new FormData;for(let e of c.files)"removed"!==localStorage.getItem(e.name)&&null!==localStorage.getItem(e.name)&&s.append("files",e),localStorage.removeItem(e.name);s.getAll("files").length>0?(n.addEventListener("load",function(){const n=JSON.parse(this.response);s.delete("files"),document.getElementsByClassName("preview")[0].remove(),n.success?e(n.info):t(n.info)}),n.upload.addEventListener("progress",function(e){let t=e.loaded/e.total*100;console.log(t)}),n.open("POST","/message/upload"),n.setRequestHeader("Accept","application/json"),n.send(s)):e(null)}).then(t=>{const s={text:a.value.trim().replace(/\r\n/g,"\n"),file:t};""!==s.text||null!==s.file?(a.value="",e.emit("send message",{msg:JSON.stringify(s),senderId:getCookie("uid"),created:Date.now()},e=>caughtEmptyMsg(e))):caughtEmptyMsg(n.error["empty message"])}).catch(e=>caughtEmptyMsg(e))}function t(){const e=JSON.parse(localStorage.getItem("active")),t=/^j:"(.*)"$/,s=location.pathname.match(/t\/(\w+)/)[1];if(null===e)return;let i=document.querySelector(".user_info-status"),a=!1;if(void 0!==n)for(let l=d.length;--l>0;){let o,r=d[l].firstChild.href,c=!1;for(let g=e.length;--g>=0;)if((o=e[g].match(t)[1])!==s||a||(i.firstChild.classList.add("active"),i.lastChild.innerText=n.chat.statusOn,a=!0),r.indexOf(o)>0){d[l].querySelector(".user-status").classList.add("active"),c=!0;break}!c&&d[l].querySelector(".user-status").classList.remove("active"),a||"hall"===s.toLowerCase()||(i.firstChild.classList.remove("active"),i.lastChild.innerText=n.chat.statusOff)}}let n,s=io.connect(),i=document.getElementById("btn-send"),a=document.getElementById("editor"),l=document.getElementsByClassName("icons-palette")[0],o=document.getElementById("messages"),r=document.getElementById("rid").value,c=document.getElementById("attachment"),d=document.getElementsByClassName("user"),g=20;loadMessages(r).then(e=>{if(e.success&&null!==e.content&&e.content.length>0)for(let t=0,n=e.content.length;t<n;++t)newMessage(e.content[t],1)}).catch(e=>console.error(e)),s.on("connect",()=>s.emit("join",{rid:r,uid:getCookie("uid")})),s.on("online",e=>localStorage.setItem("active",JSON.stringify(e))),s.on("offline",e=>localStorage.setItem("active",JSON.stringify(e))),fetch(`/asset/lang/${getCookie("lang")}.json`).then(e=>e.json()).then(e=>{n=e,t()}).catch(e=>console.error(e)),setInterval(t,6e4),a.addEventListener("keypress",t=>{13!==t.keyCode||t.shiftKey||(t.preventDefault(),e(s))}),i.addEventListener("click",()=>e(s)),s.on("_typing",e=>{let t=`<li class="message" id="typing">\n\t\t<div class="message-wrapper"> \n\t\t<div class="dot-wrapper">\n\t\t<div class="dot-hint">${e.username} is typing...</div>\n\t\t<div class="dot dot-1"></div><div class="dot dot-2"></div><div class="dot dot-3"></div>\n\t\t</div>\n\t\t</div>\n\t\t</li>`,n=document.getElementById("typing");e.typing&&!n?(o.innerHTML+=t,(n=document.getElementById("typing")).scrollIntoView({block:"end",inline:"end"})):!e.typing&&n&&n.remove()}),s.on("new message",e=>newMessage(e)),a.addEventListener("keyup",function(){setTimeout(()=>{s.emit("typing",{uid:getCookie("uid"),typing:""!==this.value})},700)}),o.addEventListener("scroll",function(){0===this.scrollTop&&g>-1&&loadMessages(r,g).then(e=>{if(e.success&&null!==e.content&&e.content.length>0){for(let t=0,n=e.content.length;t<n;++t)newMessage(e.content[t],1);g+=20}else g=-1}).catch(e=>console.error(e))}),l.addEventListener("click",e=>{let t=e.target.getAttribute("data-ic");if(null!==t){let e=a.selectionStart,n=a.selectionEnd,s=a.value;a.value=s.substring(0,e)+`:${t}:`+s.substring(n),a.focus(),a.selectionEnd=n+t.length+2}}),c.addEventListener("change",e=>{const t=e.target.files;let n=document.getElementsByClassName("preview");0===n.length?((n=document.createElement("div")).className="preview",n.innerHTML=""):n=n[0];for(let e of t)e.type.match("image.*")?n.innerHTML+=`<div class="preview_file preview_file-img">\n\t\t\t\t<img src="${(window.URL||window.webkitURL).createObjectURL(e)}">\n\t\t\t\t<div class="preview_file-close" data-name="${e.name}"></div>\n\t\t\t\t</div>`:n.innerHTML+=`<div class="preview_file">\n\t\t\t\t<i class="fa fa-download fa-white preview_file-icon"></i>\n\t\t\t\t<div class="preview_file-name">${e.name}</div>\n\t\t\t\t<div class="preview_file-close" data-name="${e.name}"></div>\n\t\t\t\t</div>`,localStorage.setItem(e.name,"added");document.getElementsByClassName("input")[0].appendChild(n)}),document.getElementById("findUser").addEventListener("keyup",function(){setTimeout(()=>{let e=this.value.trim().toLowerCase().split("");fetch("/listUsers").then(e=>{if(e.ok)return e.json();throw new Error("Something went wrong")}).then(s=>{let i=s.filter(t=>e.every(e=>t.username.toLowerCase().indexOf(e)>=0)&&t),a="";if(e.length>0&&i.length>0)for(let e of i)a+=`<li class="user"><a href="/t/${e._id}"><span class="user-name">${e.username}</span><span class="user-status"></span></a></li>`;else{a=`<li class="user"><a href="/t/hall"><span class="user-name">${n.chat.hall}</span><span class="user-status active"></span></a></li>`;for(let e of s)a+=`<li class="user"><a href="/t/${e._id}"><span class="user-name">${e.username}</span><span class="user-status"></span></a></li>`}document.querySelector(".contact_body").innerHTML=a,t()}).catch(e=>console.error(e))},700)}),document.addEventListener("click",e=>{const t=e.target;if(t.matches(".preview_file-close")){let e=t.getAttribute("data-name");null!==localStorage.getItem(e)&&localStorage.setItem(e,"removed"),t.parentNode.remove()}t.parentNode.matches(".preview_file-img")&&t.closest("#messages")&&(o.innerHTML+=`<div class="lightbox">\n\t\t\t<div class="lightbox-close preview_file-close"></div>\n\t\t\t<img src="${t.src}">\n\t\t\t</div>`),(t.parentNode.matches(".lightbox")||t.matches(".lightbox"))&&"IMG"!==t.tagName&&document.getElementsByClassName("lightbox")[0].remove()})}),function(){let e={lang:"en",bg:"dark"};null===localStorage.getItem("prefs")&&localStorage.setItem("prefs",JSON.stringify(e)),"light"===(e=JSON.parse(localStorage.getItem("prefs"))).bg?document.body.classList.add("light"):document.body.classList.remove("light")}();let menuActivator=new MenuActivator({activeClass:"chatting",listItem:document.querySelectorAll(".user a")}),actionInfoIcon=document.getElementById("action_info-icon"),btnEmoji=document.getElementById("btn-emoji"),setting=document.getElementsByClassName("setting")[0],settingIcon=document.getElementsByClassName("fa-cog")[0];menuActivator.activate(),actionInfoIcon.addEventListener("click",()=>{document.getElementsByClassName("action_info-menu")[0].classList.toggle("hidden")}),btnEmoji.addEventListener("click",()=>{document.getElementsByClassName("icons")[0].classList.toggle("hidden")}),settingIcon.addEventListener("click",()=>{setting.classList.toggle("hidden")}),setting.addEventListener("click",e=>{if(e.target.classList.contains("changeBg")){document.body.classList.toggle("light");let e=JSON.parse(localStorage.getItem("prefs"));null!==e?e.bg="dark"===e.bg?"light":"dark":e={lang:"en",bg:document.body.classList.contains("light")?"light":"dark"},localStorage.setItem("prefs",JSON.stringify(e))}else e.target.classList.contains("changeLang")&&(setCookie("lang","en"===getCookie("lang")?"vi":"en",30),location.reload())}),Number.prototype.formatTime=function(){let e=new Date(this),t=e.getDate(),n=e.getMonth()+1,s=e.getFullYear(),i=e.getHours(),a=e.getMinutes();return new Date(Date.now()).getDate()!==t?`${t<10?"0"+t:t}/${n<10?"0"+n:n}/${s} ${i<10?"0"+i:i}:${a<10?"0"+a:a}`:`${i<10?"0"+i:i}:${a<10?"0"+a:a}`};